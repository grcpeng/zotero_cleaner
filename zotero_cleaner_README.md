# Zotero 完整清理工具使用说明

## 📖 简介

Zotero 是一款优秀的文献管理工具，但在长期使用过程中，可能会积累一些冗余文件和文件夹：

- **重复的 PDF 文件**：同一篇文献可能被多次导入，产生重复副本
- **孤立的 PDF 文件**：删除文献条目后，PDF 文件可能残留在 storage 目录中
- **空文件夹**：删除附件后留下的空文件夹
- **无效文件夹**：不包含 PDF 且不在数据库中的文件夹

本工具可以自动检测并清理这些冗余数据，帮助你释放磁盘空间，保持 Zotero 数据库的整洁。

## ✨ 功能特点

### 1. 清理重复 PDF 文件
- 🔍 自动扫描 storage 目录，找出所有同名的 PDF 文件
- 📊 对比 Zotero 数据库，识别哪个副本是有效的
- ✅ 保留数据库中记录的版本，删除其他重复副本
- 📝 详细显示每个重复文件的处理方式

### 2. 清理孤立 PDF 文件
- 🔎 检测不在数据库中的 PDF 文件
- 🗑️ 将这些"孤儿"文件移动到备份目录
- 💾 避免误删，所有文件都可以从备份中恢复

### 3. 清理无效文件夹
- 🧹 自动删除空文件夹
- 🚮 删除不含 PDF 且不在数据库中的文件夹
- 🔄 循环清理，直到没有可删除的文件夹

### 4. 安全机制
- ✋ 每个步骤都需要用户确认
- 💼 所有删除的文件都先移动到备份目录
- 🔒 不会直接删除任何文件，可随时恢复

## 📋 系统要求

### 必需依赖
```bash
pip install pandas
```

### 支持的操作系统
- ✅ Windows
- ✅ macOS
- ✅ Linux

### Python 版本
- Python 3.6 或更高版本

## 🚀 使用方法

### 1. 下载脚本

将 `zotero_cleaner.py` 保存到任意目录。

### 2. 安装依赖

```bash
pip install pandas
```

### 3. 关闭 Zotero

⚠️ **重要**：运行脚本前，请先关闭 Zotero，避免数据库被锁定。

### 4. 运行脚本

```bash
python zotero_cleaner.py
```

### 5. 选择备份目录

脚本启动后会弹出文件选择对话框，选择一个用于存放删除文件的备份目录。

**建议**：选择一个容易找到的位置，如桌面或文档文件夹。

### 6. 按照提示操作

脚本会依次执行三个步骤，每个步骤都会显示详细信息并询问是否继续。

## 📊 使用示例

### 运行输出示例

```
============================================================
Zotero 完整清理工具
============================================================

备份目录: C:\Users\YourName\Desktop\zotero_backup

Zotero 数据目录: E:\data\zotero
Storage 目录: E:\data\zotero\storage

正在扫描 PDF 文件...
找到 488 个 PDF 文件

正在读取数据库...
数据库中有 460 条附件记录
数据库中有 450 个有效文件夹

统计:
  - 总 PDF 文件: 488
  - 数据库记录: 460
  - 有效文件夹: 450

============================================================
步骤 1: 清理重复的 PDF 文件
============================================================

发现 14 个重复的文件名:
============================================================

1. Smith et al. - 2023 - Deep Learning.pdf (共 2 份)
   数据库中的文件夹: ['ABC123XY']
   ✓ 保留: ABC123XY/
   ✗ 删除: DEF456ZW/

2. Wang et al. - 2024 - Machine Learning.pdf (共 2 份)
   数据库中的文件夹: ['GHI789UV']
   ✓ 保留: GHI789UV/
   ✗ 删除: JKL012ST/

...

============================================================
总计需要删除 14 个重复文件
============================================================

是否将这些重复文件移动到备份目录? (y/n): y

开始移动重复文件...
✓ 已移动: DEF456ZW/Smith et al. - 2023 - Deep Learning.pdf
✓ 已移动: JKL012ST/Wang et al. - 2024 - Machine Learning.pdf
...

成功移动 14 个重复文件

============================================================
步骤 2: 清理孤立的 PDF 文件
============================================================

没有发现孤立的 PDF 文件

============================================================
步骤 3: 清理空文件夹和无效文件夹
============================================================

✓ 已删除空文件夹: DEF456ZW
✓ 已删除空文件夹: JKL012ST
✓ 已删除无效文件夹: XYZ999AB (无PDF且不在数据库中)
...

清理统计:
  - 删除空文件夹: 15 个
  - 删除无效文件夹: 3 个
  - 总计: 18 个

============================================================
清理完成！
============================================================
  - 删除重复文件: 14 个
  - 删除孤立文件: 0 个
  - 删除文件夹: 18 个
  - 备份位置: C:\Users\YourName\Desktop\zotero_backup
============================================================
```

## 🔍 工作原理

### 1. 数据库查询

脚本会读取 Zotero 的 SQLite 数据库（`zotero.sqlite`），从 `itemAttachments` 表中提取：
- 附件的文件路径
- 对应的文件夹名称
- 关联的条目信息

### 2. 文件扫描

递归扫描 `storage` 目录，收集所有 PDF 文件的：
- 完整路径
- 文件名
- 所在文件夹

### 3. 智能匹配

通过文件名和文件夹名称，将实际文件与数据库记录进行匹配：
- **重复文件**：同一文件名在多个文件夹中出现
- **孤立文件**：文件名不在数据库记录中
- **无效文件夹**：文件夹名不在数据库中且不含 PDF

### 4. 安全清理

所有要删除的文件都会：
1. 先移动到备份目录（而非直接删除）
2. 使用文件夹名作为前缀，避免重名冲突
3. 自动处理文件名冲突（添加序号）

## ⚠️ 注意事项

### 使用前

1. **备份数据库**：虽然脚本只读取数据库不修改，但建议先备份 `zotero.sqlite`
2. **关闭 Zotero**：确保 Zotero 完全关闭，避免数据库锁定
3. **磁盘空间**：确保备份目录有足够空间存放删除的文件

### 使用中

1. **仔细检查**：脚本会显示详细的删除列表，请仔细检查后再确认
2. **分步执行**：每个步骤都可以选择跳过（输入 n）
3. **中断恢复**：可以随时按 `Ctrl+C` 中断脚本

### 使用后

1. **验证结果**：打开 Zotero，检查文献和附件是否正常
2. **保留备份**：建议保留备份文件一段时间，确认无误后再删除
3. **恢复文件**：如果误删，可以从备份目录中恢复

## 🛠️ 常见问题

### Q1: 脚本提示找不到 Zotero 配置目录？

**A**: 确保 Zotero 已正确安装。脚本会在以下位置查找：
- Windows: `%APPDATA%\Zotero\Zotero`
- macOS: `~/Library/Application Support/Zotero`
- Linux: `~/.zotero/zotero`

### Q2: 提示数据库被锁定？

**A**: 请完全关闭 Zotero（包括后台进程），然后重新运行脚本。

### Q3: 可以恢复删除的文件吗？

**A**: 可以！所有删除的文件都在备份目录中，文件名格式为：
- 重复文件：`dup_文件夹名_原文件名.pdf`
- 孤立文件：`orphan_文件夹名_原文件名.pdf`

只需将文件移回原文件夹即可恢复。

### Q4: 脚本会修改数据库吗？

**A**: 不会。脚本只读取数据库，不会进行任何修改操作。

### Q5: 为什么有些文件夹没有被删除？

**A**: 可能的原因：
- 文件夹中包含非 PDF 文件（如图片、网页快照等）
- 文件夹在数据库中有记录
- 权限不足，无法删除

### Q6: 运行脚本需要多长时间？

**A**: 取决于文件数量：
- 500 个文件：约 10-30 秒
- 5000 个文件：约 1-3 分钟
- 50000 个文件：约 10-30 分钟

## 📈 效果展示

### 清理前
```
storage/
├── ABC123XY/
│   └── paper.pdf
├── DEF456ZW/
│   └── paper.pdf          # 重复
├── GHI789UV/              # 空文件夹
├── JKL012ST/
│   └── image.png          # 无 PDF
└── MNO345PQ/
    └── orphan.pdf         # 孤立文件
```

### 清理后
```
storage/
└── ABC123XY/
    └── paper.pdf          # 保留有效文件

备份目录/
├── dup_DEF456ZW_paper.pdf
├── orphan_MNO345PQ_orphan.pdf
└── ...
```

## 🎯 适用场景

### 1. 定期维护
建议每 3-6 个月运行一次，保持数据库整洁。

### 2. 迁移前清理
在迁移 Zotero 数据到新电脑前，清理冗余文件可以减少传输时间。

### 3. 磁盘空间不足
当 storage 目录占用过多空间时，可以通过清理释放空间。

### 4. 数据库优化
清理后，Zotero 的同步和搜索速度可能会有所提升。

## 💡 最佳实践

### 1. 定期备份
在运行清理工具前，建议：
```bash
# 备份整个 Zotero 数据目录
cp -r ~/Zotero ~/Zotero_backup_$(date +%Y%m%d)
```

### 2. 分批清理
如果文件很多，可以分批清理：
- 第一次：只清理重复文件
- 第二次：清理孤立文件
- 第三次：清理文件夹

### 3. 验证结果
清理后，在 Zotero 中：
1. 检查几篇重要文献的附件是否正常
2. 尝试打开几个 PDF 文件
3. 检查同步是否正常

### 4. 保留备份
建议保留备份文件至少 1-2 周，确认无误后再删除。

## 🔧 高级用法

### 自定义清理规则

如果你想修改清理规则，可以编辑脚本中的以下函数：

```python
# 修改空文件夹判断逻辑
def is_folder_empty(path):
    # 添加更多要忽略的文件
    ignore_files = ['.DS_Store', 'Thumbs.db', 'desktop.ini', '.zotero-ft-cache']
    # ...

# 修改 PDF 检测逻辑
def has_pdf_files(path):
    # 可以添加其他文件类型
    valid_extensions = ['.pdf', '.epub', '.mobi']
    # ...
```

### 批量处理

如果你管理多个 Zotero 数据库，可以创建批处理脚本：

```bash
#!/bin/bash
# batch_clean.sh

python zotero_cleaner.py --data-dir ~/Zotero1 --backup ~/backup1
python zotero_cleaner.py --data-dir ~/Zotero2 --backup ~/backup2
```

## 📝 更新日志

### v1.0.0 (2025-01-29)
- ✨ 初始版本发布
- 🔍 支持重复 PDF 检测和清理
- 🗑️ 支持孤立 PDF 检测和清理
- 🧹 支持空文件夹和无效文件夹清理
- 💾 安全备份机制
- 🖥️ 跨平台支持（Windows/macOS/Linux）

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📄 许可证

MIT License

## ⚡ 性能优化建议

### 对于大型数据库（>10000 个文件）

1. **使用 SSD**：将 Zotero 数据目录放在 SSD 上可以显著提升扫描速度
2. **关闭杀毒软件**：临时关闭实时扫描可以加快文件操作
3. **增加内存**：确保系统有足够内存加载数据库

## 🎓 技术细节

### 数据库结构

脚本主要查询以下表：
```sql
SELECT 
    ia.itemID,
    ia.parentItemID,
    ia.path,
    i.key as itemKey
FROM itemAttachments ia
LEFT JOIN items i ON ia.itemID = i.itemID
WHERE ia.path IS NOT NULL
```

### 路径格式

Zotero 在数据库中存储的路径格式：
- `storage:文件名.pdf` - 直接在 storage 根目录
- `storage:FOLDER/文件名.pdf` - 在子文件夹中

### 文件命名规则

备份文件的命名规则：
- 重复文件：`dup_{文件夹名}_{原文件名}`
- 孤立文件：`orphan_{文件夹名}_{原文件名}`
- 冲突处理：`{基础名}_{序号}.{扩展名}`

## 📞 支持

如有问题或建议，欢迎通过以下方式联系：
- 📧 Email: your.email@example.com
- 💬 GitHub Issues: [项目地址]
- 🐦 Twitter: @yourhandle

## 🙏 致谢

感谢 Zotero 团队开发了这么优秀的文献管理工具！

---

**免责声明**：本工具仅供学习和个人使用。使用前请务必备份数据。作者不对任何数据丢失负责。
